"0","## Fonctions de traitement raster et cartographie"
"0","library(raster)"
"0","library(tmap)"
"0","library(leaflet)"
"0","library(scales)"
"0","library(sf)"
"0","library(exactextractr)"
"0","library(dplyr)"
"0","library(DT)"
"0","library(gt)"
"0","library(gtExtras)"
"0",""
"0","# Fonction de chargement et visualisation de raster"
"0","render_indicator_raster <- function(indicator_name, palette = ""viridis"") {"
"0","  path <- paste0(""data/"", indicator_name, ""/"", indicator_name, ""_niger.tif"")"
"0","  rast <- raster(path)"
"0","  "
"0","  static_map <- tm_shape(rast) +"
"0","    tm_raster(style = ""quantile"", palette = palette, title = toupper(indicator_name)) +"
"0","    tm_layout(main.title = paste0(toupper(indicator_name), "" â€“ niger (2024)""),"
"0","              legend.outside = TRUE)"
"0","  "
"0","  pal_fun <- colorNumeric(palette = palette, domain = values(rast), na.color = ""transparent"")"
"0","  interactive_map <- leaflet() %>%"
"0","    addProviderTiles(""CartoDB.Positron"") %>%"
"0","    addRasterImage(rast, colors = pal_fun, opacity = 0.8) %>%"
"0","    addLegend(pal = pal_fun, values = values(rast), title = indicator_name, position = ""bottomright"")"
"0","  "
"0","  list(static = static_map, interactive = interactive_map, raster = rast)"
"0","}"
"0",""
"0","# ðŸ”¹ Fonction dâ€™extraction zonale"
"0","extract_raster_by_region <- function(raster_obj, shapefile_path, region_id = ""ADM1_FR"", "
"0","                                     indicator_name = NULL, scale_if_needed = TRUE) {"
"0","  regions <- st_read(shapefile_path, quiet = TRUE)"
"0","  mean_vals <- exact_extract(raster_obj, regions, 'mean')"
"0","  "
"0",""
"0","  to_normalize <- c(""ndvi"", ""evi"")"
"0","  "
"0",""
"0","  if (scale_if_needed && !is.null(indicator_name) && tolower(indicator_name) %in% to_normalize) {"
"0","    mean_vals <- mean_vals / 10000"
"0","  }"
"0","  "
"0","  regions$mean_value <- round(mean_vals, 3)"
"0","  return(regions)"
"0","}"
"0",""
"0","# ðŸ”¹ Carte interactive enrichie avec Titre"
"0","plot_raster_aggregated_leaflet <- function(raster_obj, shapefile_path, palette = ""YlGn"", "
"0","                                           region_id = ""ADM1_FR"", title = ""Indice"","
"0","                                           indicator_name = NULL, scale_if_needed = TRUE) {"
"0","  "
"0","  regions <- extract_raster_by_region("
"0","    raster_obj = raster_obj,"
"0","    shapefile_path = shapefile_path,"
"0","    region_id = region_id,"
"0","    indicator_name = indicator_name,"
"0","    scale_if_needed = scale_if_needed"
"0","  )"
"0","  "
"0","  region_names <- regions[[region_id]]"
"0","  mean_values <- regions$mean_value"
"0","  "
"0","  pal <- colorNumeric(palette = palette, domain = mean_values, na.color = ""transparent"")"
"0","  "
"0","  leaflet_map <- leaflet(regions) %>%"
"0","    addProviderTiles(""CartoDB.Positron"") %>%"
"0","    addPolygons("
"0","      fillColor = ~pal(mean_value),"
"0","      weight = 1,"
"0","      color = ""#666"","
"0","      fillOpacity = 0.7,"
"0","      label = lapply(seq_along(region_names), function(i) {"
"0","        paste0(region_names[i], "" : "", mean_values[i])"
"0","      }),"
"0","      popup = lapply(seq_along(region_names), function(i) {"
"0","        paste(""<b>RÃ©gion :</b>"", region_names[i], ""<br><b>Valeur moyenne :</b>"", mean_values[i])"
"0","      }),"
"0","      labelOptions = labelOptions(direction = ""auto"")"
"0","    ) %>%"
"0","    addLegend("
"0","      pal = pal,"
"0","      values = mean_values,"
"0","      title = paste(""Valeur moyenne â€“"", title),"
"0","      position = ""bottomright"""
"0","    ) %>%"
"0","    addControl("
"0","      html = paste0("
"0","        ""<div style='background:white;padding:6px 12px;border-radius:6px;"
"0","                      box-shadow:0 0 5px rgba(0,0,0,0.3);"
"0","                      font-size:16px;font-weight:bold'>"", title, ""</div>"""
"0","      ),"
"0","      position = ""topright"""
"0","    )"
"0","  "
"0","  return(leaflet_map)"
"0","}"
"0",""
